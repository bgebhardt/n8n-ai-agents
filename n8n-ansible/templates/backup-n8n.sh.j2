# =============================================================================
# File: templates/backup-n8n.sh.j2
# =============================================================================
#!/bin/bash

# n8n AI Starter Kit Backup Script
# Generated by Ansible

set -e

BACKUP_DIR="{{ n8n_data_dir }}/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="n8n_backup_${DATE}.tar.gz"

# Create backup directory
mkdir -p "$BACKUP_DIR"

# Export n8n workflows
echo "Exporting n8n workflows..."
cd {{ n8n_data_dir }}
docker compose exec -T n8n n8n export:workflow --backup --output=/home/node/.n8n/backups/workflows_${DATE}.json || true

# Create full backup
echo "Creating full backup..."
tar -czf "${BACKUP_DIR}/${BACKUP_FILE}" \
    --exclude='{{ n8n_data_dir }}/backups' \
    --exclude='*.log' \
    {{ n8n_data_dir }}

# Clean up old backups (keep last 7 days)
find "$BACKUP_DIR" -name "n8n_backup_*.tar.gz" -mtime +7 -delete

echo "Backup completed: ${BACKUP_DIR}/${BACKUP_FILE}"

# Optional: Upload to cloud storage
# uncomment and configure as needed
# aws s3 cp "${BACKUP_DIR}/${BACKUP_FILE}" s3://your-backup-bucket/
# rclone copy "${BACKUP_DIR}/${BACKUP_FILE}" remote:backup/